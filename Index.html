<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Infrações</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: #37474f;
      color: #fff;
      padding: 16px;
      text-align: center;
    }
    .container {
      max-width: 960px;
      margin: 20px auto;
      padding: 0 16px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .tab-btn {
      flex: 1;
      padding: 12px;
      border: none;
      background: #e0e0e0;
      color: #333;
      cursor: pointer;
      border-radius: 6px;
      font-weight: bold;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .tab-btn.active {
      background: #1565c0;
      color: #fff;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .form-group {
      margin-bottom: 12px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    input[type="text"], select, textarea, input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    textarea { resize: vertical; min-height: 80px; }
    .actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
    button {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      background: #1565c0;
      color: #fff;
    }
    button.secondary { background: #78909c; }
    .message { margin-top: 8px; font-weight: bold; }
    .message.success { color: #2e7d32; }
    .message.error { color: #c62828; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
      font-size: 14px;
    }
    th { background: #f5f5f5; }
    .badge-yes { color: #2e7d32; font-weight: bold; }
    .badge-no { color: #c62828; font-weight: bold; }
    .hidden { display: none; }
    @media (max-width: 640px) {
      th, td { font-size: 12px; }
      .tab-btn { flex: 1 1 100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Controle de Infrações do Podcast</h1>
  </header>
  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-infracao">Registrar infração</button>
      <button class="tab-btn" data-tab="tab-tarefas">Gerenciar tarefas</button>
      <button class="tab-btn" data-tab="tab-historico">Histórico</button>
    </div>

    <div id="tab-infracao" class="card tab-content active">
      <div class="form-group">
        <label for="tarefaSelect">Tarefa</label>
        <select id="tarefaSelect"></select>
      </div>
      <div class="form-group">
        <label for="responsavel">Responsável</label>
        <input type="text" id="responsavel" readonly />
      </div>
      <div class="form-group">
        <label for="registradoPor">Registrado por</label>
        <select id="registradoPor">
          <option value="Bruno">Bruno</option>
          <option value="Xandão">Xandão</option>
        </select>
      </div>
      <div class="form-group">
        <label for="dataInfracao">Data da infração</label>
        <input type="date" id="dataInfracao" />
      </div>
      <div class="form-group">
        <label for="observacao">Observação</label>
        <textarea id="observacao" placeholder="Opcional"></textarea>
      </div>
      <div class="actions">
        <button id="btnRegistrar">Registrar infração</button>
      </div>
      <div id="msgInfracao" class="message"></div>
    </div>

    <div id="tab-tarefas" class="card tab-content hidden">
      <div class="form-group" hidden>
        <input type="text" id="tarefaId" />
      </div>
      <div class="form-group">
        <label for="tarefaNome">Nome da tarefa</label>
        <input type="text" id="tarefaNome" />
      </div>
      <div class="form-group">
        <label for="tarefaResponsavel">Responsável</label>
        <select id="tarefaResponsavel">
          <option value="Bruno">Bruno</option>
          <option value="Xandão">Xandão</option>
        </select>
      </div>
      <div class="form-group">
        <label for="tarefaAtiva">Ativa?</label>
        <select id="tarefaAtiva">
          <option value="true">Sim</option>
          <option value="false">Não</option>
        </select>
      </div>
      <div class="actions">
        <button id="btnSalvarTarefa">Salvar tarefa</button>
        <button id="btnLimparTarefa" class="secondary">Limpar formulário</button>
      </div>
      <div id="msgTarefa" class="message"></div>

      <table id="tabelaTarefas">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Responsável</th>
            <th>Ativa</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="tab-historico" class="card tab-content hidden">
      <table id="tabelaHistorico">
        <thead>
          <tr>
            <th>Tarefa</th>
            <th>Responsável</th>
            <th>Registrado por</th>
            <th>Data da infração</th>
            <th>Registro</th>
            <th>Dentro do prazo?</th>
            <th>Conta ponto?</th>
            <th>Obs.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.add('hidden'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.remove('hidden');
        if (btn.dataset.tab === 'tab-historico') {
          loadHistorico();
        }
      });
    });

    document.getElementById('tarefaSelect').addEventListener('change', (e) => {
      const tarefa = tarefasAtivas.find(t => t.id === e.target.value);
      document.getElementById('responsavel').value = tarefa ? tarefa.responsavel : '';
    });

    document.getElementById('btnRegistrar').addEventListener('click', registrarInfracao);
    document.getElementById('btnSalvarTarefa').addEventListener('click', salvarTarefa);
    document.getElementById('btnLimparTarefa').addEventListener('click', limparFormTarefa);

    let tarefasCache = [];
    let tarefasAtivas = [];

    function showMessage(elementId, message, isError = false) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = 'message ' + (isError ? 'error' : 'success');
    }

    function loadTarefas() {
      google.script.run
        .withSuccessHandler((tarefas) => {
          tarefasCache = tarefas || [];
          tarefasAtivas = tarefasCache.filter(t => t.ativa);
          preencherSelectTarefas();
          preencherTabelaTarefas();
        })
        .withFailureHandler((err) => {
          showMessage('msgInfracao', 'Erro ao carregar tarefas: ' + err.message, true);
        })
        .getTarefas();
    }

    function preencherSelectTarefas() {
      const select = document.getElementById('tarefaSelect');
      select.innerHTML = '<option value="">Selecione uma tarefa</option>';
      tarefasAtivas.forEach((t) => {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = `${t.nome} (${t.responsavel})`;
        select.appendChild(option);
      });
      document.getElementById('responsavel').value = '';
    }

    function preencherTabelaTarefas() {
      const tbody = document.querySelector('#tabelaTarefas tbody');
      tbody.innerHTML = '';
      tarefasCache.forEach((t) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.nome}</td>
          <td>${t.responsavel}</td>
          <td>${t.ativa ? 'Sim' : 'Não'}</td>
          <td>
            <button class="secondary" onclick="editarTarefa('${t.id}')">Editar</button>
            <button class="secondary" onclick="excluirTarefa('${t.id}')">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function registrarInfracao() {
      const tarefaId = document.getElementById('tarefaSelect').value;
      const dataInfracao = document.getElementById('dataInfracao').value;
      const registradoPor = document.getElementById('registradoPor').value;
      const observacao = document.getElementById('observacao').value;

      if (!tarefaId) {
        showMessage('msgInfracao', 'Selecione uma tarefa.', true);
        return;
      }
      if (!dataInfracao) {
        showMessage('msgInfracao', 'Informe a data da infração.', true);
        return;
      }

      const payload = { tarefaId, dataInfracao, registradoPor, observacao };

      google.script.run
        .withSuccessHandler((res) => {
          if (res.success) {
            showMessage('msgInfracao', res.message, false);
            document.getElementById('dataInfracao').value = '';
            document.getElementById('observacao').value = '';
            loadHistorico();
          } else {
            showMessage('msgInfracao', res.message, true);
          }
        })
        .withFailureHandler((err) => {
          showMessage('msgInfracao', 'Erro ao registrar: ' + err.message, true);
        })
        .registerInfracao(payload);
    }

    function salvarTarefa() {
      const id = document.getElementById('tarefaId').value;
      const nome = document.getElementById('tarefaNome').value.trim();
      const responsavel = document.getElementById('tarefaResponsavel').value;
      const ativa = document.getElementById('tarefaAtiva').value === 'true';

      if (!nome) {
        showMessage('msgTarefa', 'Informe o nome da tarefa.', true);
        return;
      }

      const payload = { id, nome, responsavel, ativa };

      google.script.run
        .withSuccessHandler((res) => {
          if (res.success) {
            showMessage('msgTarefa', res.message, false);
            limparFormTarefa();
            loadTarefas();
          } else {
            showMessage('msgTarefa', res.message, true);
          }
        })
        .withFailureHandler((err) => {
          showMessage('msgTarefa', 'Erro ao salvar tarefa: ' + err.message, true);
        })
        .saveTarefa(payload);
    }

    function limparFormTarefa() {
      document.getElementById('tarefaId').value = '';
      document.getElementById('tarefaNome').value = '';
      document.getElementById('tarefaResponsavel').value = 'Bruno';
      document.getElementById('tarefaAtiva').value = 'true';
      showMessage('msgTarefa', '', false);
    }

    function editarTarefa(id) {
      const tarefa = tarefasCache.find(t => t.id === id);
      if (!tarefa) return;
      document.getElementById('tarefaId').value = tarefa.id;
      document.getElementById('tarefaNome').value = tarefa.nome;
      document.getElementById('tarefaResponsavel').value = tarefa.responsavel;
      document.getElementById('tarefaAtiva').value = tarefa.ativa ? 'true' : 'false';
      showMessage('msgTarefa', 'Editando tarefa selecionada.', false);
    }

    function excluirTarefa(id) {
      if (!confirm('Deseja excluir esta tarefa?')) return;
      google.script.run
        .withSuccessHandler((res) => {
          if (res.success) {
            showMessage('msgTarefa', res.message, false);
            loadTarefas();
          } else {
            showMessage('msgTarefa', res.message, true);
          }
        })
        .withFailureHandler((err) => {
          showMessage('msgTarefa', 'Erro ao excluir tarefa: ' + err.message, true);
        })
        .deleteTarefa(id);
    }

    function loadHistorico() {
      google.script.run
        .withSuccessHandler((infracoes) => {
          const tbody = document.querySelector('#tabelaHistorico tbody');
          tbody.innerHTML = '';
          (infracoes || []).forEach((inf) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${inf.nomeTarefa}</td>
              <td>${inf.responsavel}</td>
              <td>${inf.registradoPor}</td>
              <td>${inf.dataInfracao}</td>
              <td>${inf.dataRegistro}</td>
              <td class="${inf.dentroPrazo ? 'badge-yes' : 'badge-no'}">${inf.dentroPrazo ? 'Sim' : 'Não'}</td>
              <td class="${inf.contaPonto ? 'badge-yes' : 'badge-no'}">${inf.contaPonto ? 'Sim' : 'Não'}</td>
              <td>${inf.observacao || ''}</td>
            `;
            tbody.appendChild(tr);
          });
        })
        .withFailureHandler((err) => {
          const tbody = document.querySelector('#tabelaHistorico tbody');
          tbody.innerHTML = `<tr><td colspan="8">Erro ao carregar histórico: ${err.message}</td></tr>`;
        })
        .getInfracoes();
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadTarefas();
      limparFormTarefa();
    });
  </script>
</body>
</html>
