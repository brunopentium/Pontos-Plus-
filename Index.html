<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Infrações</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root {
      --primary: #1565c0;
      --primary-dark: #0d47a1;
      --surface: rgba(255, 255, 255, 0.9);
      --text: #1f2933;
      --muted: #5f6b76;
      --glass-border: rgba(255, 255, 255, 0.4);
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', Arial, sans-serif;
      background: radial-gradient(circle at 15% 20%, rgba(21, 101, 192, 0.15), transparent 30%),
        radial-gradient(circle at 85% 10%, rgba(13, 71, 161, 0.18), transparent 35%),
        linear-gradient(135deg, #f4f7fb 0%, #e7edf7 100%);
      margin: 0;
      padding: 0;
      color: var(--text);
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #0d47a1, #1565c0);
      color: #fff;
      padding: 22px 16px 18px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 8px 24px rgba(13, 71, 161, 0.24);
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.3rem, 2vw + 1rem, 1.8rem);
      letter-spacing: 0.4px;
    }

    header p {
      margin: 6px 0 0;
      color: rgba(255, 255, 255, 0.88);
      font-weight: 500;
      font-size: 0.95rem;
    }

    .container {
      max-width: 1040px;
      margin: 20px auto 32px;
      padding: 0 14px 24px;
    }

    .card {
      background: var(--surface);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 16px;
      box-shadow: 0 12px 40px rgba(13, 71, 161, 0.08);
      border: 1px solid rgba(13, 71, 161, 0.08);
      backdrop-filter: blur(10px);
    }

    .login-card {
      max-width: 520px;
      margin: 0 auto 18px;
    }

    .tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin: 10px 0 18px;
    }

    .tab-btn {
      padding: 12px 14px;
      border: 1px solid var(--glass-border);
      background: linear-gradient(145deg, rgba(255,255,255,0.7), rgba(227,242,253,0.9));
      color: var(--text);
      cursor: pointer;
      border-radius: 14px;
      font-weight: 700;
      transition: all 0.2s ease;
      box-shadow: 0 10px 25px rgba(21, 101, 192, 0.08);
      backdrop-filter: blur(12px);
    }

    .tab-btn:hover { transform: translateY(-1px); }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      box-shadow: 0 16px 32px rgba(13, 71, 161, 0.22);
    }

    .section-title {
      margin: 0 0 12px;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-dark);
      letter-spacing: 0.2px;
    }

    .form-group { margin-bottom: 14px; }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--muted);
    }

    input[type="text"], select, textarea, input[type="date"], input[type="month"] {
      width: 100%;
      padding: 11px 12px;
      border: 1.2px solid rgba(13, 71, 161, 0.18);
      border-radius: 12px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.82);
      color: var(--text);
      box-shadow: inset 0 1px 2px rgba(13, 71, 161, 0.04);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.12);
    }

    textarea { resize: vertical; min-height: 90px; }

    .actions {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 11px 16px;
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      cursor: pointer;
      font-weight: 700;
      background: linear-gradient(145deg, rgba(255,255,255,0.7), rgba(227,242,253,0.9));
      color: var(--primary-dark);
      box-shadow: 0 12px 30px rgba(13, 71, 161, 0.12);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
      backdrop-filter: blur(10px);
    }

    button:hover { transform: translateY(-1px); box-shadow: 0 16px 38px rgba(13, 71, 161, 0.16); }

    button:active { transform: translateY(0); }

    button.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      border-color: rgba(255, 255, 255, 0.16);
    }

    button.secondary {
      background: linear-gradient(135deg, #eceff1, #dde2e7);
      color: #37474f;
    }

    .message {
      margin-top: 8px;
      font-weight: 700;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(227, 242, 253, 0.8);
      color: var(--primary-dark);
    }

    .message.success { color: #2e7d32; background: rgba(200, 230, 201, 0.75); }

    .message.error { color: #c62828; background: rgba(244, 199, 199, 0.78); }

    #paretoContainer {
      position: relative;
      height: 320px;
      background: rgba(255, 255, 255, 0.86);
    }

    #paretoChart {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid rgba(13, 71, 161, 0.08);
      box-shadow: inset 0 1px 1px rgba(13, 71, 161, 0.06);
      background: rgba(255, 255, 255, 0.92);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 640px;
    }

    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid rgba(13, 71, 161, 0.08);
      text-align: left;
      font-size: 14px;
    }

    th { background: rgba(227, 242, 253, 0.7); color: var(--primary-dark); }

    .badge-yes { color: #2e7d32; font-weight: bold; }
    .badge-no { color: #c62828; font-weight: bold; }
    .hidden { display: none; }

    .tarefa-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .tarefa-button {
      padding: 13px 12px;
      background: linear-gradient(145deg, rgba(255,255,255,0.72), rgba(227,242,253,0.95));
      border-radius: 12px;
      border: 1px solid rgba(13, 71, 161, 0.14);
      cursor: pointer;
      text-align: left;
      transition: all 0.2s ease;
      font-weight: 700;
      color: #1f2933;
      box-shadow: 0 10px 25px rgba(13, 71, 161, 0.08);
      backdrop-filter: blur(8px);
    }

    .tarefa-button:hover { transform: translateY(-1px); box-shadow: 0 12px 28px rgba(13, 71, 161, 0.12); }

    .tarefa-button.selected {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(21, 101, 192, 0.16), rgba(21, 101, 192, 0.28));
      color: var(--primary-dark);
    }

    .app-hidden { display: none; }
    .hidden-field { display: none; }

    @media (max-width: 720px) {
      .container { padding: 0 12px 22px; }
      .actions { flex-direction: column; }
      button { width: 100%; text-align: center; }
      table { min-width: 520px; }
    }

    @media (max-width: 520px) {
      header { padding: 18px 14px; }
      .card { padding: 16px; }
      .tabs { grid-template-columns: 1fr; }
      .tarefa-buttons { grid-template-columns: 1fr; }
    }
  </style>
</head>
  <body>
  <header>
    <h1>Controle de Infrações do Podcast</h1>
    <p>Visual moderno, leve e otimizado para o seu smartphone</p>
  </header>
  <div class="container">
    <div id="loginSection" class="card login-card">
      <h2>Login</h2>
      <div class="form-group">
        <label for="loginUsuario">Usuário</label>
        <input type="text" id="loginUsuario" placeholder="bruno ou alexandre" />
      </div>
      <div class="form-group">
        <label for="loginSenha">Senha</label>
        <input type="password" id="loginSenha" />
      </div>
      <div class="actions">
        <button id="btnLogin" class="primary">Entrar</button>
      </div>
      <div id="msgLogin" class="message"></div>
    </div>

    <div id="appSection" class="app-hidden">
      <div class="card" id="usuarioInfo" style="margin-bottom: 12px;">
        <strong>Usuário logado:</strong> <span id="usuarioLogado"></span>
      </div>
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-infracao">Registrar infração</button>
      <button class="tab-btn" data-tab="tab-tarefas">Gerenciar tarefas</button>
      <button class="tab-btn" data-tab="tab-historico">Histórico</button>
    </div>

    <div id="tab-infracao" class="card tab-content active">
      <div class="form-group">
        <label>Tarefas do outro responsável</label>
        <div id="tarefaButtons" class="tarefa-buttons"></div>
      </div>
      <div class="form-group hidden-field">
        <label for="tarefaSelecionadaNome">Tarefa selecionada</label>
        <input type="text" id="tarefaSelecionadaNome" readonly placeholder="Nenhuma tarefa selecionada" />
      </div>
      <div class="form-group hidden-field">
        <label for="responsavel">Responsável</label>
        <input type="text" id="responsavel" readonly />
      </div>
      <div class="form-group hidden-field">
        <label>Dia limite da tarefa</label>
        <div id="infoDiaLimite">Selecione uma tarefa para ver o dia limite.</div>
      </div>
      <div class="form-group hidden-field">
        <label for="registradoPor">Registrado por</label>
        <input type="text" id="registradoPor" readonly />
      </div>
      <div class="form-group hidden-field">
        <label for="dataInfracao">Data da infração</label>
        <input type="date" id="dataInfracao" />
      </div>
      <div class="form-group">
        <label for="observacao">Observação</label>
        <textarea id="observacao" placeholder="Opcional"></textarea>
      </div>
      <div class="actions">
        <button id="btnRegistrar" class="primary">Registrar infração</button>
      </div>
      <div id="msgInfracao" class="message"></div>

      <div class="card" id="paretoContainer">
        <h3>Pareto de Infrações</h3>
        <div class="form-group">
          <label for="mesPareto">Mês de referência</label>
          <input type="month" id="mesPareto" />
        </div>
        <canvas id="paretoChart" height="220"></canvas>
        <div id="paretoMensagem" class="message"></div>
      </div>
    </div>

    <div id="tab-tarefas" class="card tab-content hidden">
      <div class="form-group" hidden>
        <input type="text" id="tarefaId" />
      </div>
      <div class="form-group">
        <label for="tarefaNome">Nome da tarefa</label>
        <input type="text" id="tarefaNome" />
      </div>
      <div class="form-group">
        <label for="tarefaResponsavel">Responsável</label>
        <select id="tarefaResponsavel">
          <option value="Bruno">Bruno</option>
          <option value="Xandão">Xandão</option>
        </select>
      </div>
      <div class="form-group">
        <label for="tarefaDiaLimite">Dia da semana (data limite)</label>
        <select id="tarefaDiaLimite"></select>
      </div>
      <div class="form-group">
        <label for="tarefaAtiva">Ativa?</label>
        <select id="tarefaAtiva">
          <option value="true">Sim</option>
          <option value="false">Não</option>
        </select>
      </div>
      <div class="actions">
        <button id="btnSalvarTarefa" class="primary">Salvar tarefa</button>
        <button id="btnLimparTarefa" class="secondary">Limpar formulário</button>
      </div>
      <div id="msgTarefa" class="message"></div>

      <div class="table-wrapper">
        <table id="tabelaTarefas">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Responsável</th>
              <th>Dia limite</th>
              <th>Ativa</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="tab-historico" class="card tab-content hidden">
      <div class="table-wrapper">
        <table id="tabelaHistorico">
          <thead>
            <tr>
              <th>Tarefa</th>
              <th>Responsável</th>
              <th>Registrado por</th>
              <th>Data da infração</th>
              <th>Registro</th>
              <th>Dentro do prazo?</th>
              <th>Conta ponto?</th>
              <th>Obs.</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    const USERS = {
      bruno: { senha: 'Cesar177*', nome: 'Bruno', podeGerenciar: true },
      alexandre: { senha: 'plus123', nome: 'Xandão', podeGerenciar: false },
    };
    const STORAGE_USER_KEY = 'pontosPlusCurrentUser';

    const diasSemana = [
      { value: 'segunda', label: 'Segunda-feira' },
      { value: 'terca', label: 'Terça-feira' },
      { value: 'quarta', label: 'Quarta-feira' },
      { value: 'quinta', label: 'Quinta-feira' },
      { value: 'sexta', label: 'Sexta-feira' },
      { value: 'sabado', label: 'Sábado' },
      { value: 'domingo', label: 'Domingo' },
    ];

    let tarefasCache = [];
    let tarefasAtivas = [];
    let paretoChart;

    const paretoValueLabelsPlugin = {
      id: 'paretoValueLabels',
      afterDatasetsDraw(chart) {
        const { ctx } = chart;
        ctx.save();

        chart.data.datasets.forEach((dataset, datasetIndex) => {
          const meta = chart.getDatasetMeta(datasetIndex);
          meta.data.forEach((element, index) => {
            const value = dataset.data[index];
            if (value === null || value === undefined) return;

            ctx.fillStyle = '#2c2c2c';
            ctx.font = 'bold 11px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';

            const position = element.tooltipPosition();
            ctx.fillText(value, position.x, position.y - 6);
          });
        });

        ctx.restore();
      },
    };
    let currentUser = null;
    let tarefaSelecionadaId = '';

    function getCurrentDateStr() {
      return new Date().toISOString().split('T')[0];
    }

    function showMessage(elementId, message, isError = false) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = 'message ' + (isError ? 'error' : 'success');
    }

    function preencherSelectDiaLimite() {
      const select = document.getElementById('tarefaDiaLimite');
      select.innerHTML = '<option value="">Selecione o dia limite</option>';
      diasSemana.forEach((d) => {
        const option = document.createElement('option');
        option.value = d.value;
        option.textContent = d.label;
        select.appendChild(option);
      });
    }

    function obterLabelDia(valor) {
      const dia = diasSemana.find(d => d.value === valor);
      return dia ? dia.label : '';
    }

    function atualizarInfoDiaLimite(tarefa) {
      const info = document.getElementById('infoDiaLimite');
      if (!tarefa || !tarefa.diaLimite) {
        info.textContent = 'Selecione uma tarefa para ver o dia limite.';
        return;
      }
      const label = obterLabelDia(tarefa.diaLimite) || 'dia não informado';
      info.textContent = `Limite da tarefa: ${label}. Somente é possível registrar no dia seguinte a esse limite.`;
    }

    function renderizarBotoesTarefas() {
      const container = document.getElementById('tarefaButtons');
      container.innerHTML = '';
      tarefaSelecionadaId = '';
      document.getElementById('tarefaSelecionadaNome').value = '';
      document.getElementById('responsavel').value = '';
      atualizarInfoDiaLimite(null);

      if (!currentUser) return;

      const outrasTarefas = tarefasAtivas.filter((t) => t.responsavel !== currentUser.nome);
      if (!outrasTarefas.length) {
        const aviso = document.createElement('div');
        aviso.textContent = 'Nenhuma tarefa do outro responsável para registrar.';
        container.appendChild(aviso);
        return;
      }

      outrasTarefas.forEach((tarefa) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'tarefa-button';
        btn.dataset.id = tarefa.id;
        btn.textContent = `${tarefa.nome} (${tarefa.responsavel})`;
        btn.addEventListener('click', () => selecionarTarefa(tarefa.id));
        container.appendChild(btn);
      });
    }

    function selecionarTarefa(tarefaId) {
      tarefaSelecionadaId = tarefaId;
      const container = document.getElementById('tarefaButtons');
      container.querySelectorAll('.tarefa-button').forEach((btn) => {
        btn.classList.toggle('selected', btn.dataset.id === tarefaId);
      });

      const tarefa = tarefasAtivas.find((t) => t.id === tarefaId);
      document.getElementById('tarefaSelecionadaNome').value = tarefa ? tarefa.nome : '';
      document.getElementById('responsavel').value = tarefa ? tarefa.responsavel : '';
      atualizarInfoDiaLimite(tarefa);
    }

    function preencherTabelaTarefas() {
      const tbody = document.querySelector('#tabelaTarefas tbody');
      tbody.innerHTML = '';
      tarefasCache.forEach((t) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.nome}</td>
          <td>${t.responsavel}</td>
          <td>${obterLabelDia(t.diaLimite) || 'Não informado'}</td>
          <td>${t.ativa ? 'Sim' : 'Não'}</td>
          <td>
            <button class="secondary" onclick="editarTarefa('${t.id}')">Editar</button>
            <button class="secondary" onclick="excluirTarefa('${t.id}')">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function loadTarefas() {
      google.script.run
        .withSuccessHandler((tarefas) => {
          tarefasCache = tarefas || [];
          tarefasAtivas = tarefasCache.filter(t => t.ativa);
          renderizarBotoesTarefas();
          preencherTabelaTarefas();
        })
        .withFailureHandler((err) => {
          showMessage('msgInfracao', 'Erro ao carregar tarefas: ' + err.message, true);
        })
        .getTarefas();
    }

    function registrarInfracao() {
      if (!currentUser) {
        showMessage('msgInfracao', 'Faça login para registrar.', true);
        return;
      }

      if (!tarefaSelecionadaId) {
        showMessage('msgInfracao', 'Selecione uma tarefa.', true);
        return;
      }

      const dataInfracao = document.getElementById('dataInfracao').value || getCurrentDateStr();
      const observacao = document.getElementById('observacao').value;

      if (!dataInfracao) {
        showMessage('msgInfracao', 'Informe a data da infração.', true);
        return;
      }

      if (!confirm('Tem Certeza?')) return;

      const payload = {
        tarefaId: tarefaSelecionadaId,
        dataInfracao,
        registradoPor: currentUser.nome,
        observacao,
      };

      google.script.run
        .withSuccessHandler((res) => {
          if (res.success) {
            showMessage('msgInfracao', res.message, false);
            document.getElementById('observacao').value = '';
            alert('Registrado');
            loadHistorico();
            loadPareto();
          } else {
            showMessage('msgInfracao', res.message, true);
          }
        })
        .withFailureHandler((err) => {
          showMessage('msgInfracao', 'Erro ao registrar: ' + err.message, true);
        })
        .registerInfracao(payload);
    }

    function aplicarPermissoesTabs() {
      const tabTarefasBtn = document.querySelector('[data-tab="tab-tarefas"]');
      const tabInfracaoBtn = document.querySelector('[data-tab="tab-infracao"]');
      if (!currentUser?.podeGerenciar) {
        tabTarefasBtn.classList.add('hidden');
        if (tabTarefasBtn.classList.contains('active')) {
          ativarTab('tab-infracao');
        }
      } else {
        tabTarefasBtn.classList.remove('hidden');
      }
      tabInfracaoBtn?.classList.add('active');
      document.getElementById('tab-infracao').classList.remove('hidden');
    }

    function ativarTab(tabId) {
      tabButtons.forEach((btn) => {
        if (btn.dataset.tab === tabId && !btn.classList.contains('hidden')) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      tabContents.forEach((content) => {
        content.classList.toggle('hidden', content.id !== tabId);
      });
      if (tabId === 'tab-historico') {
        loadHistorico();
      }
    }

    function iniciarAposLogin() {
      document.getElementById('loginSection').classList.add('app-hidden');
      document.getElementById('appSection').classList.remove('app-hidden');
      document.getElementById('usuarioLogado').textContent = currentUser.nome;
      document.getElementById('registradoPor').value = currentUser.nome;
      aplicarPermissoesTabs();
      tarefaSelecionadaId = '';
      limparFormTarefa();
      ajustarMaxDataInfracao();
      inicializarMesPareto();
      loadTarefas();
      loadPareto();
      loadHistorico();
    }

    function salvarLoginLocal(usuarioChave) {
      try {
        localStorage.setItem(STORAGE_USER_KEY, usuarioChave);
      } catch (e) {
        console.warn('Não foi possível salvar o login localmente.', e);
      }
    }

    function restaurarLogin() {
      try {
        const savedUser = localStorage.getItem(STORAGE_USER_KEY);
        if (savedUser && USERS[savedUser]) {
          currentUser = USERS[savedUser];
          ativarTab('tab-infracao');
          iniciarAposLogin();
        }
      } catch (e) {
        console.warn('Não foi possível restaurar o login salvo.', e);
      }
    }

    function realizarLogin() {
      const usuarioInput = (document.getElementById('loginUsuario').value || '').trim().toLowerCase();
      const senhaInput = document.getElementById('loginSenha').value || '';
      const userInfo = USERS[usuarioInput];

      if (!userInfo || userInfo.senha !== senhaInput) {
        showMessage('msgLogin', 'Usuário ou senha inválidos.', true);
        return;
      }

      currentUser = userInfo;
      salvarLoginLocal(usuarioInput);
      showMessage('msgLogin', '', false);
      ativarTab('tab-infracao');
      iniciarAposLogin();
    }

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.classList.contains('hidden')) return;
        ativarTab(btn.dataset.tab);
      });
    });

    document.getElementById('btnLogin').addEventListener('click', realizarLogin);
    document.getElementById('btnRegistrar').addEventListener('click', registrarInfracao);
    document.getElementById('btnSalvarTarefa').addEventListener('click', salvarTarefa);
    document.getElementById('btnLimparTarefa').addEventListener('click', limparFormTarefa);
    document.getElementById('mesPareto').addEventListener('change', loadPareto);

    function salvarTarefa() {
      const id = document.getElementById('tarefaId').value;
      const nome = document.getElementById('tarefaNome').value.trim();
      const responsavel = document.getElementById('tarefaResponsavel').value;
      const diaLimite = document.getElementById('tarefaDiaLimite').value;
      const ativa = document.getElementById('tarefaAtiva').value === 'true';

      if (!nome) {
        showMessage('msgTarefa', 'Informe o nome da tarefa.', true);
        return;
      }

      if (!diaLimite) {
        showMessage('msgTarefa', 'Selecione o dia limite da tarefa.', true);
        return;
      }

      const payload = { id, nome, responsavel, diaLimite, ativa };

      google.script.run
        .withSuccessHandler((res) => {
          if (res.success) {
            showMessage('msgTarefa', res.message, false);
            limparFormTarefa();
            loadTarefas();
          } else {
            showMessage('msgTarefa', res.message, true);
          }
        })
        .withFailureHandler((err) => {
          showMessage('msgTarefa', 'Erro ao salvar tarefa: ' + err.message, true);
        })
        .saveTarefa(payload);
    }

    function limparFormTarefa() {
      document.getElementById('tarefaId').value = '';
      document.getElementById('tarefaNome').value = '';
      document.getElementById('tarefaResponsavel').value = 'Bruno';
      document.getElementById('tarefaDiaLimite').value = '';
      document.getElementById('tarefaAtiva').value = 'true';
      showMessage('msgTarefa', '', false);
    }

    function editarTarefa(id) {
      const tarefa = tarefasCache.find(t => t.id === id);
      if (!tarefa) return;
      document.getElementById('tarefaId').value = tarefa.id;
      document.getElementById('tarefaNome').value = tarefa.nome;
      document.getElementById('tarefaResponsavel').value = tarefa.responsavel;
      document.getElementById('tarefaDiaLimite').value = tarefa.diaLimite || '';
      document.getElementById('tarefaAtiva').value = tarefa.ativa ? 'true' : 'false';
      showMessage('msgTarefa', 'Editando tarefa selecionada.', false);
    }

    function excluirTarefa(id) {
      if (!confirm('Deseja excluir esta tarefa?')) return;
      google.script.run
        .withSuccessHandler((res) => {
          if (res.success) {
            showMessage('msgTarefa', res.message, false);
            loadTarefas();
          } else {
            showMessage('msgTarefa', res.message, true);
          }
        })
        .withFailureHandler((err) => {
          showMessage('msgTarefa', 'Erro ao excluir tarefa: ' + err.message, true);
        })
        .deleteTarefa(id);
    }

    function loadHistorico() {
      google.script.run
        .withSuccessHandler((infracoes) => {
          const tbody = document.querySelector('#tabelaHistorico tbody');
          tbody.innerHTML = '';
          (infracoes || []).forEach((inf) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${inf.nomeTarefa}</td>
              <td>${inf.responsavel}</td>
              <td>${inf.registradoPor}</td>
              <td>${inf.dataInfracao}</td>
              <td>${inf.dataRegistro}</td>
              <td class="${inf.dentroPrazo ? 'badge-yes' : 'badge-no'}">${inf.dentroPrazo ? 'Sim' : 'Não'}</td>
              <td class="${inf.contaPonto ? 'badge-yes' : 'badge-no'}">${inf.contaPonto ? 'Sim' : 'Não'}</td>
              <td>${inf.observacao || ''}</td>
            `;
            tbody.appendChild(tr);
          });
        })
        .withFailureHandler((err) => {
          const tbody = document.querySelector('#tabelaHistorico tbody');
          tbody.innerHTML = `<tr><td colspan="8">Erro ao carregar histórico: ${err.message}</td></tr>`;
        })
        .getInfracoes();
    }

    function prepararDadosPareto(infracoes, mesSelecionado) {
      const contagem = { Bruno: 0, 'Xandão': 0 };
      const responsaveisConsiderados = ['Bruno', 'Xandão'];

      const isMesSelecionado = (dataRef) => {
        if (!mesSelecionado) return true;
        if (!dataRef || typeof dataRef !== 'string' || !dataRef.includes('-')) return false;
        const [ano, mes] = dataRef.split('-').map(Number);
        const [anoFiltro, mesFiltro] = mesSelecionado.split('-').map(Number);
        return ano === anoFiltro && mes === mesFiltro;
      };

      infracoes.forEach((inf) => {
        if (!responsaveisConsiderados.includes(inf.responsavel)) return;
        if (!inf.contaPonto) return;

        const dataReferencia = inf.dataRegistro || inf.dataInfracao;
        if (!isMesSelecionado(dataReferencia)) return;

        contagem[inf.responsavel] = (contagem[inf.responsavel] || 0) + 1;
      });

      const entries = Object.entries(contagem).sort((a, b) => b[1] - a[1]);

      const total = entries.reduce((sum, [, value]) => sum + value, 0);
      if (total === 0) {
        return { labels: [], valores: [] };
      }

      return {
        labels: entries.map(([nome]) => nome),
        valores: entries.map(([, value]) => value),
      };
    }

    function renderizarPareto(dados) {
      const mensagem = document.getElementById('paretoMensagem');
      if (!dados.labels.length) {
        mensagem.textContent = 'Nenhuma infração registrada no período selecionado.';
        mensagem.className = 'message';
        if (paretoChart) {
          paretoChart.destroy();
          paretoChart = null;
        }
        return;
      }

      mensagem.textContent = '';
      mensagem.className = 'message';

      const ctx = document.getElementById('paretoChart').getContext('2d');
      if (paretoChart) {
        paretoChart.destroy();
      }

      paretoChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dados.labels,
          datasets: [
            {
              type: 'bar',
              label: 'Total de infrações',
              data: dados.valores,
              backgroundColor: '#1565c0',
              borderColor: '#0d47a1',
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Total',
              },
            },
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => `${context.parsed.y} infrações`,
              },
            },
            legend: {
              labels: {
                font: {
                  size: 12,
                },
              },
            },
          },
        },
        plugins: [paretoValueLabelsPlugin],
      });
    }

    function loadPareto() {
      const mesSelecionado = document.getElementById('mesPareto').value;
      google.script.run
        .withSuccessHandler((infracoes) => {
          const dados = prepararDadosPareto(infracoes || [], mesSelecionado);
          renderizarPareto(dados);
        })
        .withFailureHandler((err) => {
          const mensagem = document.getElementById('paretoMensagem');
          mensagem.textContent = 'Erro ao carregar gráfico: ' + err.message;
          mensagem.className = 'message error';
        })
        .getInfracoes();
    }

    function ajustarMaxDataInfracao() {
      const hojeStr = getCurrentDateStr();
      const input = document.getElementById('dataInfracao');
      input.value = hojeStr;
      input.readOnly = true;
      input.setAttribute('max', hojeStr);
    }

    function inicializarMesPareto() {
      const hoje = new Date();
      const mesStr = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('mesPareto').value = mesStr;
    }

    document.addEventListener('DOMContentLoaded', () => {
      preencherSelectDiaLimite();
      ajustarMaxDataInfracao();
      inicializarMesPareto();
      restaurarLogin();
    });
  </script>
</body>
</html>
